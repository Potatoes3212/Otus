# Описание ADR-5 Обработка нотификации о смене подписки

## Контекст
Биллинговые системы присылают callback об изменении состояния подписки. Необходимо обрабатывать callback и изменять условия использования для пользователя в соответствии с подпиской. 
### Текущая архитектура
Callback не обрабатывается. Подписка пользователя синхронизируется при запросе с FE.

### Архитектурные драйверы
* Невозможно проинформировать пользователя об изменении состояния подписки в момент наступления события.
* Приходится делать частые запросы во внешнюю систему для синхронизации подписок

### Цели
* Не делать слишком частые запросы во внешнюю систему для синхронизации подписки
* Обрабатывать callback от биллинга об изменении состояния подписки
## Критичные сценарии и критичные характеристики
**Критичные сценарии:**
* Изменение состояния подписки во внешней системе 
* Синхронизация подписки с внешней системой
* Добавление нового шага к обработке изменения подписки

**Критерии оценки решений:**
* Скорость получения нотификации (внешние системы имею малый timeout для отправки callback)
* Стоимость добавления нового этапа обработки нотификации
* Скорость обработки нотификации 
* Отказоустойчивость решения 
* Стоимость разработки решения

## Варианты решения 
### Решение 1. Использовать Outbox для сохранения + паттерн синхронная SAGA для обработки нотификации
Callback-receiver принимает нотификацию, кладёт в Outbox. Subscription-manager читает нотификации, и вызывает последовательность методов во внешних сервисах для применения нового состояния.

**Преимущества**
* Сохранение консистентности настроек пользователя 
* Сценарий применения изменений сконцентрирован в одном месте
* Простой дебаг 
* Низкая стоимость реализации решения
* Высокая скорость обработки нотификации за счёт прямых вызовов методов из оркестратора

**Недостатки**
* Высокая нагрузка на subscription-manager, от начала до конца выполнения SAGA сервису необходимо хранить контекст.
* Низкая отказоустойчивость. Если один из методов, участвующих в обработке будет недоступен, то откажет весь процесс обработки нотификации.
* Высокая трудоёмкость при внесении изменений в процесс обработки за счёт синхронного процесса. 

### Решение 2. Использовать Outbox для сохранения + паттерн асинхронная SAGA для обработки нотификации
Callback-receiver принимает нотификацию, кладёт в Outbox. Subscription-manager читает нотификации, и отправляет в топик событие изменения подписки у пользователя сервисы обработки читают топик и применяют изменения. При ошибке обработки отправляют событие в топик с ошибками и другие сервисы при получении события делают роллбек своих изменений. 

**Преимущества**
* Сохранение консистентности настроек пользователя 
* Низкая трудоёмкость при внесении изменений в процесс обработки за счёт отсутствия оркестратора
* Приемлемая скорость обработки нотификации за счёт параллельной обработки в разных сервисах

**Недостатки**
* Низкая отказоустойчивость. Если один из методов, участвующих в обработке будет недоступен, то откажет весь процесс обработки нотификации
* Высокая стоимость разработки решения. Необходимо в каждом сервисе делать чтение дополнительного топика с ошибками обработки в других сервисах и сценарий роллбека
* Сложный дебаг

### Решение 3. Использовать Outbox для сохранения + простую асинхронную обработку события в сервисах
Callback-receiver принимает нотификацию, кладёт в Outbox. Subscription-manager читает нотификации, и отправляет в топик событие изменения подписки у пользователя сервисы обработки читают топик и применяют изменения. При ошибке сервис только пишет в лог. 

**Преимущества**
* Низкая трудоёмкость при внесении изменений в процесс обработки за счёт отсутствия оркестратора
* Высокая отказоустойчивость. Обработка будет завершена при отказе одного из сервисов обработчиков
* Приемлемая скорость обработки нотификации за счёт параллельной обработки в разных сервисах
* Низкая стоимость обработки решения за счёт отсутствия механизма роллбека


**Недостатки**
* Сложный дебаг
* Консистентность настроек пользователя может быть нарушена при отказе одного из сервисов обработчиков события

# Решение 
Выбрано решение 3 т.к. оно лучше всего отвечает критериям оценки. 
> Использовать Outbox для сохранения + простую асинхронную обработку события в сервисах.

## Последствия решения 
**Положительные**
* Высокая скорость получения нотификации обеспечивается за счёт паттерна Outbox. Callback-receiver принимает нотификацию, но не обрабатывает. 
* Стоимость добавления нового этапа обработки нотификации низкая, т.к. для добавления нужно только добавить нового читателя топика уведомлений об изменении состояния подписки.
* Скорость обработки нотификации высокая за счёт параллельной обработки события несколькими читателями.
* Отказоустойчивость решения высокая за счёт независимости обработчиков события.
* Стоимость разработки решения низкая за счёт отсутствия механизма роллбека

**Отрицательные**
* Необходимо выполнять синхронизацию подписки с внешней биллинговой системой, т.к. возможно нарушение консистентности настроек подписки пользователя.