# ADR-1 Использование BFF
## Контекст
### Текущая архитектура
![context_diagram](/Software_Architect/HW1/diagrams/conponent_diagram_as_is.png)
### Архитектурные драйверы
* Сложно подойти к переписыванию legacy сервисов, т.к. их API напрямую запрашивается с клиента
* В legacy сервисы невозможно интегрировать новые методы пользовательской авторизации
* FrontEnd разработчикам неудобно разбираться в "зоопарке" API
* Проведение A/B тестов невозможно т.к. может повлиять на работу всех витрин продукта
### Цели
* Изменить подход к публикации API, чтобы система была легко модифицируема и могла масштабироваться под растущее количество пользователей.
## Критичные сценарии и критичные характеристики
**Критичные сценарии:**
* Пользователи просматривают контент в мобильно/web приложении 
* Пользователи просматривают контент в виджетах экосистемных продуктов
* Смартфоны пользователей отправляют данные на Backend продукта 
* Команда разработки выполняет обновление/замену сервисов на backend 

**Критерии оценки решений:**
* Скорость выполнения запроса
* Ресурсы необходимые на применение решения
* Возможность модификации API используемого FrontEnd`ом
* Ресурсы необходимые на запуск новой фичи
* Влияние на доступность сервиса

## Варианты решения

### Архитектурное решение 1. Оставить текущую архитектуру 
**Преимущества:**
* Затраты на разработку решения отсутствуют
* Время выполнения запроса зависит от одного сервиса
* Для наиболее важных витрин (собственных приложений) нет дополнительной точки отказа в виде BFF
* Нет дополнительных затрат на создание/доработку API метода в BFF сервисе

**Недостатки:**
* Для замены устаревших сервисов необходимо выполнять релиз web/app приложений
* Все сервисы имеют функционал проверки авторизации пользователя, проверка происходит при каждом запросе 
* Разработчики вынуждены поддерживать legacy сервисы, т.к. их замена сопряжена с рисками и затратами
* Обширный мониторинг необходимо настраивать на всех сервисах, т.к. пользовательские приложения напрямую к ним обращаются
* Контракты данных могут отличаться от сервиса к сервису

### Архитектурное решение 2. Общий BFF сервис под все витрины продута
![context_diagram](/Software_Architect/HW1/diagrams/component_diagram_tobe2.png)
**Преимущества**
* За BFF сервисом можно выполнять замену сервиса без влияния на FrontEnd, что должно сократить время разработки новых фич на BackEnd 
* Проверку авторизации может выполнять только BFF сервис, сервисы за BFF доверяют выполненной проверке
* Основной мониторинг настраивается только на BFF сервисе
* В критических случаях есть возможность внести логику в BFF сервис
* API имеет понятные контракты данных и семантику для FrontEnd разработчиков
* В перспективе даёт ускорение разработки новых фич, т.к. есть возможность переписать legacy сервисы и меньше беспокоиться об обратной совместимости

**Недостатки**
* Затраты ресурсов на создание/доработку API метода в BFF сервисе N+1
* К времени выполнения запроса прибавляется время на проксирование
* BFF сервис является единой точкой отказа для всех витрин
* Наиболее нагруженные витрины влияют на работоспособность менее нагруженных, при разном влиянии на бизнес

### Архитектурное решение 3. Выделенный BFF сервис для витрин
![context_diagram](/Software_Architect\HW1\diagrams\component_diagram_tobe3.png)
**Преимущества**
* За BFF сервисом можно выполнять замену сервиса без влияния на FrontEnd, что должно сократить время разработки новых фич на BackEnd 
* Проверку авторизации может выполнять только BFF сервис, сервисы за BFF доверяют выполненной проверке
  * Для разных витрин может поддерживаться разная авторизация
* Основной мониторинг настраивается только на BFF сервисах
* В критических случаях есть возможность внести логику в BFF сервис
* API имеет понятные контракты данных и семантику для FrontEnd разработчиков
* Есть возможность отключить нагрузку от наименее важных витрин для восстановления работоспособности наиболее важных

**Недостатки**
* Затраты ресурсов на создание/доработку API метода в BFF сервисе N+количество категорий витрин
* К времени выполнения запроса прибавляется время на проксирование
* BFF сервис является единой точкой отказа одной категории витрин
* Дополнительные затраты на настройку мониторинга в сравнении с единым BFF сервисом

# Решение 
На основе сравнения преимуществ и недостатков принято решение разработать "Выделенный BFF сервис для витрин". 

## Последствия решения 
**Положительные**
* На дистанции отдельные прокси сервисы улучшают возможность к модифицируемости продукта
* Можно отказаться от поддержки legacy сервисов
* Легче поддерживать изменения в экосистемных модулях
* Появляется возможность проведения A/B тестов за счёт перенаправления запросов в прокси сервисе

**Отрицательные**
* Увеличивается время на обработку запроса, но рассчитываем, на то, что это нивелируется отказом от проверки авторизации пользователя в сервисах за прокси
* Необходимо разработать дополнительный BFF сервис 
* Необходимо публиковать внешние API сервисов только через прокси сервис.